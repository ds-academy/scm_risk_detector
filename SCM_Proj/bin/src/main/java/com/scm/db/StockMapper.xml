<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.scm.db.StockMapper">
	
	<!-- 명시적인 매핑 추가 -->
    <resultMap id="StockResultMap" type="com.scm.model.StockDTO">
        <result property="companyName" column="COMPANY_NAME"/>
        <result property="currentClose" column="CURRENT_CLOSE"/>
        <result property="percentChange" column="PERCENT_CHANGE"/>
    </resultMap>
	

    <!-- 회사 코드별 주식 종가 데이터 조회 (그래프용) -->
    <select id="getClosePriceByCompany" parameterType="String" resultType="com.scm.model.StockDTO">
        SELECT CLOSE, DATE
        FROM STOCK_PRICE
        WHERE COMPANY_CODE = #{COMPANY_CODE}
        ORDER BY DATE DESC
        LIMIT 8;
    </select>

	<select id="getKospiClose" resultType="double">
    SELECT CLOSE
    FROM STOCK_PRICE
    WHERE COMPANY_CODE = 'KS11'
    ORDER BY DATE DESC
    LIMIT 1
</select>

<select id="getKosdaqClose" resultType="double">
    SELECT CLOSE
    FROM STOCK_PRICE
    WHERE COMPANY_CODE = 'KQ11'
    ORDER BY DATE DESC
    LIMIT 1
</select>

<select id="getSP500Close" resultType="double">
    SELECT CLOSE
    FROM STOCK_PRICE
    WHERE COMPANY_CODE = '^GSPC'
    ORDER BY DATE DESC
    LIMIT 1
</select>


    <!-- 코스피 지수 최근 7일 -->
    <select id="getKospiIndex" resultType="com.scm.model.StockDTO">
        SELECT CLOSE, DATE
        FROM STOCK_PRICE
        WHERE COMPANY_CODE = 'KS11'
        ORDER BY DATE DESC
        LIMIT 7
    </select>

    <!-- 거래량 최근 7일 -->
    <select id="getKospiVolume" resultType="com.scm.model.StockDTO">
        SELECT VOLUME, DATE
        FROM STOCK_PRICE
        WHERE COMPANY_CODE = 'KQ11'
        ORDER BY DATE DESC
        LIMIT 7
    </select>
	
	
	<!-- 쿼리에서 resultMap 사용 -->
    <select id="getStockInfoByCompany" parameterType="String" resultMap="StockResultMap">
        SELECT 
            cm.COMPANY_NAME AS COMPANY_NAME,
            sp.`CLOSE` AS CURRENT_CLOSE,
            CASE 
                WHEN prev_sp.`CLOSE` IS NULL THEN 0
                ELSE ROUND(((sp.`CLOSE` - prev_sp.`CLOSE`) / prev_sp.`CLOSE`) * 100, 2)
            END AS PERCENT_CHANGE
        FROM STOCK_PRICE sp
        LEFT JOIN (
            SELECT COMPANY_CODE, `CLOSE`, `DATE`
            FROM STOCK_PRICE
        ) prev_sp 
        ON sp.COMPANY_CODE = prev_sp.COMPANY_CODE 
        AND prev_sp.`DATE` = (
            SELECT MAX(sub_sp.`DATE`) 
            FROM STOCK_PRICE sub_sp
            WHERE sub_sp.COMPANY_CODE = sp.COMPANY_CODE 
            AND sub_sp.`DATE` &lt;  sp.`DATE`
        )
        JOIN COMPANY_META cm ON sp.COMPANY_CODE = cm.COMPANY_CODE
        WHERE sp.COMPANY_CODE = #{companyCode}
        ORDER BY sp.`DATE` DESC
        LIMIT 1;
    </select>


	
	
	
	
</mapper>
